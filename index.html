<!-- WAJIB: Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
document.addEventListener("DOMContentLoaded", () => {

  // Pastikan canvas ada
  const canvas = document.getElementById("waterChart");
  if (!canvas) {
    console.error("Canvas waterChart TIDAK ditemukan!");
    return;
  }

  const ctx = canvas.getContext("2d");

  // Firebase setup
  import {
    initializeApp
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";

  import {
    getDatabase, ref, onValue, set
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBfl6c9wZk-KtF6SI1SepauIlgB1xxrR5w",
    authDomain: "watchflooood.firebaseapp.com",
    databaseURL: "https://watchflooood-default-rtdb.firebaseio.com",
    projectId: "watchflooood",
    storageBucket: "watchflooood.firebasestorage.app",
    messagingSenderId: "433015826288",
    appId: "1:433015826288:web:79d5f44884921b267c91b5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const refJarak = ref(db, "Sensor/Jarak");
  const refReset = ref(db, "Command/Reset");

  console.log("Firebase connected, Chart.js loaded.");

  // Chart
  const waterChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [{
        label: "Water Level (cm)",
        data: [],
        borderColor: "#007bff",
        backgroundColor: "rgba(0,123,255,0.25)",
        borderWidth: 3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      animation: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 100
        }
      }
    }
  });

  const tinggiBak = 100;

  // Listener realtime
  onValue(refJarak, snapshot => {
    const jarak = Number(snapshot.val());

    if (isNaN(jarak)) {
      console.warn("Data jarak tidak valid:", snapshot.val());
      return;
    }

    const tinggiAir = Math.max(0, Math.min(tinggiBak - jarak, tinggiBak));
    const waktu = new Date().toLocaleTimeString();

    waterChart.data.labels.push(waktu);
    waterChart.data.datasets[0].data.push(tinggiAir);

    if (waterChart.data.labels.length > 20) {
      waterChart.data.labels.shift();
      waterChart.data.datasets[0].data.shift();
    }

    waterChart.update();
  });

  // Reset chart listener
  onValue(refReset, snapshot => {
    if (snapshot.val() === 1) {
      waterChart.data.labels = [];
      waterChart.data.datasets[0].data = [];
      waterChart.update();
      set(refReset, 0);
    }
  });

});
</script>
